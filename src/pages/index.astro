---
import Layout from '../layouts/Layout.astro';

// Importamos los componentes modulares
import Loader from '../components/Loader.astro';
import Cursor from '../components/Cursor.astro';
import Hero from '../components/Hero.astro';
import Manifesto from '../components/Manifesto.astro';
import Tour from '../components/Tour.astro';
import Crowd from '../components/Crowd.astro';
// AÑADIDO: Importamos el nuevo componente
import TextWheel from '../components/TextWheel.astro';
import Footer from '../components/Footer.astro';
---

<Layout title="OSCAR HERRERA | GLOBAL FREQUENCY">
    
    <Loader />
    <Cursor />

    <div id="smooth-wrapper">
        <div id="smooth-content">
            
            <Hero />
            <Manifesto />
            <Tour />
            <Crowd />

            <TextWheel text="TECHNO • OSCAR HERRERA • LIVE • " />
   
            <Footer />

        </div>
    </div>

</Layout>

<script>
    import { gsap } from "gsap";
    import { ScrollTrigger } from "gsap/ScrollTrigger";
    import Lenis from "@studio-freight/lenis";

    // Registrar plugins globalmente
    gsap.registerPlugin(ScrollTrigger);

    // ---------------------------------------------
    // 1. Configuración Global de Lenis (Smooth Scroll)
    // ---------------------------------------------
    const lenis = new Lenis({
        duration: 1.2,
        easing: (t: number) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
        smoothWheel: true
    });

    function raf(time: number) {
        lenis.raf(time);
        requestAnimationFrame(raf);
    }
    requestAnimationFrame(raf);

    // Conectar Lenis con ScrollTrigger para que funcionen juntos
    lenis.on('scroll', ScrollTrigger.update);

    gsap.ticker.add((time) => {
        lenis.raf(time * 1000);
    });

    // ---------------------------------------------
    // 2. Sistema Global de Cambio de Color (Body)
    // ---------------------------------------------
    // Busca todas las secciones dentro de los componentes que tengan 'data-bgcolor'
    const sections = document.querySelectorAll('[data-bgcolor]');

    sections.forEach(section => {
        const el = section as HTMLElement;
        ScrollTrigger.create({
            trigger: el,
            start: "top 50%",
            end: "bottom 50%",
            onEnter: () => updateColors(el),
            onEnterBack: () => updateColors(el)
        });
    });

    function updateColors(section: HTMLElement) {
        const bgColor = section.dataset.bgcolor;
        const textColor = section.dataset.textcolor;
        
        if (bgColor && textColor) {
            gsap.to("body", {
                backgroundColor: bgColor,
                color: textColor,
                duration: 0.5
            });
        }
    }

    // ---------------------------------------------
    // 3. Efecto Glitch Global al hacer Scroll Rápido
    // ---------------------------------------------
    let lastScrollY = 0;

    lenis.on('scroll', ({ scroll }: { scroll: number }) => {
        const velocity = Math.abs(scroll - lastScrollY);
        lastScrollY = scroll;

        // Si la velocidad es alta, aplicamos el efecto a cualquier elemento con clase .glitch-target
        if (velocity > 15) {
            gsap.to(".glitch-target", {
                skewY: velocity * 0.1,
                filter: "hue-rotate(90deg)",
                duration: 0.1
            });
        } else {
            gsap.to(".glitch-target", {
                skewY: 0,
                filter: "hue-rotate(0deg)",
                duration: 0.3
            });
        }
    });
</script>